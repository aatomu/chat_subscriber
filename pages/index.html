<!DOCTYPE html>
<html>

<head>
  <meta charset="utf-8">
  <title>Live Chat Leader</title>
  <style>
    :root {
      --youtube-default: #C4302B;
      --youtube: #FF3F38;
      --twitch-default: #6441A5;
      --twitch: #9A63FF;
    }

    html {
      height: 100%;
    }

    body {
      height: 100%;
      background-color: lightgreen;
      margin: 0px auto;
    }

    .contents {
      display: flex;
      flex-direction: column;
      justify-content: flex-end;

      height: 100%;

      line-height: 32px;
    }

    .content {
      display: flex;
      flex-direction: row;
      align-items: flex-start;

      background-color: rgba(255, 255, 255, 0.75);
      border-radius: 10px;

      padding: 4px;
      margin: 4px 0;

      animation: invisible 1s linear 300s 1 normal both;
    }

    .content.youtube {
      border-width: 3px;
      border-style: solid;
      border-color: var(--youtube);
    }

    .content.twitch {
      border-width: 3px;
      border-style: solid;
      border-color: var(--twitch);
    }

    @keyframes invisible {
      100% {
        opacity: 0;
      }
    }

    .content>* {
      margin-left: 4px;
      margin-right: 4px;
    }

    .time {
      margin: 0px 8px;

      font-size: 70%;
      color: gray;
      white-space: pre;
    }

    .icon {
      display: flex;
      align-items: center;

      height: 32px;
    }

    .icon>* {
      height: 90%;
      aspect-ratio: 1/1;
      box-sizing: border-box;
      border-radius: 50%;
    }

    .twitch-icon {
      display: flex;
      justify-content: center;
      align-items: center;

      border-color: black;
      border-style: solid;
      border-width: 2px;


      font-weight: bold;
      color: white;
      background-color: var(--twitch);
    }

    .name {
      font-size: 120%;
      color: gray;
      white-space: pre;
    }

    .message {
      font-size: 120%;
      font-weight: bold;
      word-break: break-all;
    }

    .message>img {
      height: 24px;
      aspect-ratio: 1/1;
      vertical-align: middle;
    }

    .message-root {
      width: 100%;
    }

    .money {
      border-radius: 8px;
      padding: 0 10px;
    }

    .channel {
      float: right;
      opacity: 0.75;

      border-radius: 16px;

      padding: 0 8px;
      margin-top: 1px;

      color: #ffffff;
      font-size: 18px;
      font-weight: bold;
      white-space: pre;
    }

    .youtube .channel {
      background-color: var(--youtube);
    }

    .twitch .channel {
      background-color: var(--twitch);
    }
  </style>
</head>

<body>
  <div id="contents" class="contents">
  </div>
</body>

<script id="message-functions">
  const CONTENTS = document.getElementById("contents")

  function addMessage(timestamp = 0, iconURL = "", name = "", message = "", channelID = "", site = "") {
    // Root
    const CONTENT = document.createElement("div")
    CONTENT.classList.add("content")
    switch (site) {
      case "youtube":
        CONTENT.classList.add("youtube")
        break
      case "twitch":
        CONTENT.classList.add("twitch")
        break
    }
    // Timestamp
    const TIME = new Date(timestamp)
    const TIMESTAMP = document.createElement("span")
    TIMESTAMP.classList.add("time")
    TIMESTAMP.innerText = `${String(TIME.getHours()).padStart(2, "0")}:${String(TIME.getMinutes()).padStart(2, "0")}:${String(TIME.getSeconds()).padStart(2, "0")}`
    CONTENT.append(TIMESTAMP)
    // Icon
    const ICON_ROOT = document.createElement("div")
    ICON_ROOT.classList.add("icon")
    switch (site) {
      case "youtube":
        const ICON_YOUTUBE = document.createElement("img")
        ICON_YOUTUBE.src = iconURL
        ICON_ROOT.append(ICON_YOUTUBE)
        break
      case "twitch":
        // const ICON_TWITCH = document.createElement("div")
        // ICON_TWITCH.classList.add("twitch-icon")
        // ICON_TWITCH.innerText = "T"
        const ICON_TWITCH = document.createElement("img")
        ICON_TWITCH.src = "https://www.freepnglogos.com/uploads/twitch-logo-symbol-25.png"

        ICON_ROOT.append(ICON_TWITCH)
        break
    }
    CONTENT.append(ICON_ROOT)
    // Name
    const NAME = document.createElement("span")
    NAME.classList.add("name")
    NAME.innerText = name
    CONTENT.append(NAME)
    // Badges
    // Message
    const MESSAGE_ROOT = document.createElement("div")
    MESSAGE_ROOT.classList.add("message-root")
    const MESSAGE = document.createElement("span")
    MESSAGE.classList.add("message")
    MESSAGE.innerHTML = message
    MESSAGE_ROOT.append(MESSAGE)
    const CHANNEL = document.createElement("span")
    CHANNEL.classList.add("channel")
    CHANNEL.innerText = channelID
    MESSAGE_ROOT.append(CHANNEL)
    CONTENT.append(MESSAGE_ROOT)

    if (CONTENTS.children.length >= CHAT_COUNT_LIMIT) {
      CONTENTS.firstElementChild.remove()
    }
    CONTENTS.append(CONTENT)

    bottomScroll()
  }
  function bottomScroll() {
    let elm = document.documentElement;

    // scrollHeight ページの高さ clientHeight ブラウザの高さ
    let bottom = elm.scrollHeight - elm.clientHeight;

    // 垂直方向へ移動
    window.scroll(0, bottom);
  }
</script>

<script id="live-subscriber">
  const SEARCH_PARAMS = new URLSearchParams(window.location.search)
  const CHAT_COUNT_LIMIT = SEARCH_PARAMS.get("limit") ? parseInt(SEARCH_PARAMS.get("limit")) : 20

  if (SEARCH_PARAMS.size == 0) {
    document.getElementById("contents").innerHTML += `
    <div class="content youtube">
      <span class="time">99:99:99</span>
      <div class="icon">
        <img src="https://pbs.twimg.com/profile_images/1480130282099740684/uNSmGF1F_400x400.jpg">
      </div>
      <span class="name">aatomu</span>
      <div class="message-root">
        <span class="message">How To Use:
          /?youtube=@ChannelID&youtube=ChannelID&twitch=ChannelID&twitch=ChannelID&limit=ChatLimit
          More Information: <a href="https://github.com/aatomu/chat_subscriber">https://github.com/aatomu/chat_subscriber</a></span>
        <span class="channel">#develop-message</span>
      </div>
    </div>
  </div>
  `
  }

  // Twitch
  const TWITCH_IRC_URI = "wss://irc-ws.chat.twitch.tv:443"
  SEARCH_PARAMS.getAll("twitch").forEach((channelID) => {
    console.log("Twtich: ", channelID)
    const WEBSOCKET = new WebSocket(TWITCH_IRC_URI)

    WEBSOCKET.addEventListener("open", function (event) {
      console.log(`WebSocket Open(#${channelID}):\n`, event)
      WEBSOCKET.send("CAP REQ :twitch.tv/tags twitch.tv/commands")
      WEBSOCKET.send("PASS SCHMOOPIIE")
      const RANDOM_NUMBER = Math.floor(Math.random() * 100000)
      const USER_NAME = `justinfan${String(RANDOM_NUMBER).padStart(5, "0")}`
      WEBSOCKET.send(`NICK ${USER_NAME}`)
      WEBSOCKET.send(`USER ${USER_NAME} 8 * :${USER_NAME}`)
      WEBSOCKET.send(`JOIN #${channelID}`)
    })
    WEBSOCKET.addEventListener("message", function (event) {
      const CHAT_LIST = twitchParseMessage(event.data)
      CHAT_LIST.forEach(chat => {
        switch (chat.command) {
          case "PRIVMSG":
            // Parse Emotes
            let emoteReplaceList = []
            for (emoteID in chat.tags.emotes) {
              const EMOTE_POSITIONS = chat.tags.emotes[emoteID]
              EMOTE_POSITIONS.forEach(emotePosition => {
                emoteReplaceList.push({
                  id: emoteID,
                  start: emotePosition.start,
                  end: emotePosition.end,
                })
              })
            }
            emoteReplaceList.sort((a, b) => {
              if (a.start > b.start) {
                return -1
              } else {
                return 1
              }
            })
            // Replace Emote string => Emote image
            let message = chat.params[1]
            message = message.replaceAll(/^\x01|\x01$/g, "") // 特殊文字削除
            message = message.replace(/^ACTION /, "")// Action削除
            let sliceMessage = [...message]

            for (let index = 0; index < emoteReplaceList.length; index++) {
              const EMOTE = emoteReplaceList[index]
              sliceMessage.splice(EMOTE.start, EMOTE.end - EMOTE.start + 1, `<img src="https://static-cdn.jtvnw.net/emoticons/v2/${EMOTE.id}/default/light/1.0">`)
            }

            console.log(`WebSocket Message(${chat.params[0]}):\n`, chat)
            addMessage(new Date().getTime(), "", chat.prefix.nick, sliceMessage.join(""), chat.params[0], "twitch")
            break;
          case "PING":
            WEBSOCKET.send("PONG")
            break
        }
      })
    })
    WEBSOCKET.addEventListener("close", function (event) {
      console.log(`WebSocket Close(#${channelID}):\n`, event)
    })
    WEBSOCKET.addEventListener("error", function (event) {
      console.log(`WebSocket Error(#${channelID}):\n`, event)
    })
  })


  // Youtube
  SEARCH_PARAMS.getAll("youtube").forEach(async (channelID,) => {
    console.log("Youtube: ", channelID)
    const TOKEN = await fetch(`https://live-chat.aatomu.workers.dev?id=${channelID}`).then(res => {
      return res.json()
    }).then(json => {
      return json
    })
    console.log(TOKEN)

    let token = TOKEN
    setInterval(async function () {
      const CHAT_RESPONSE = await fetch(`https://live-chat.aatomu.workers.dev?api_key=${token.api_key}&client_version=${token.client_version}&continuation=${token.continuation}`).then(res => {
        return res.json()
      }).then(json => {
        return json
      })

      if (!CHAT_RESPONSE.continuationContents) {
        return
      }
      const CHAT_CONTENTS = CHAT_RESPONSE.continuationContents.liveChatContinuation

      // Parse Chat Data
      if (CHAT_CONTENTS.actions) {
        const CHAT_LIST = youtubeParseChat(CHAT_CONTENTS.actions, channelID)
        CHAT_LIST.forEach((chat) => {
          const CHAT_OFFSET_TIME = (chat.timestampMilliSecond + 5000) - (new Date().getTime())
          setTimeout(function () {
            let message = ""
            if (chat.superchat != null) {
              message = `<span class="money" style="color:${chat.superchat.textColor} ; background-color: ${chat.superchat.backgroundColor};">${chat.superchat.amount}</span> `
            }
            for (let index = 0; index < chat.message.length; index++) {
              message += chat.message[index].text
            }

            console.log(`Youtube Message(${channelID}):\n`, chat)
            addMessage(chat.timestampMilliSecond, chat.author.image[0].url, chat.author.name, message, channelID, "youtube")
          }, CHAT_OFFSET_TIME)
        })
      }

      // Move Chat Position
      const CONTINUATION_DATA = CHAT_CONTENTS.continuations[0]
      if (CONTINUATION_DATA.invalidationContinuationData) {
        token.continuation = CONTINUATION_DATA.invalidationContinuationData.continuation
      } else if (CONTINUATION_DATA.timedContinuationData) {
        token.continuation = CONTINUATION_DATA.timedContinuationData.continuation
      }
    }, 5000)
  })
</script>

<script id="twitch-script">
  function twitchParseMessage(messages) {
    let chatList = []
    messages.split("\r\n").forEach((message) => {
      if (message == "") {
        return
      }
      let chat = {}

      // Tags
      if (message.startsWith("@")) {
        const NEXT_SPACE = message.indexOf(" ")
        const TAGS = message.substring(1, NEXT_SPACE)
        message = message.substring(NEXT_SPACE + 1)
        chat["tags"] = twitchParseTags(TAGS)
      }
      // Prefix
      if (message.startsWith(":")) {
        const NEXT_SPACE = message.indexOf(" ")
        const PREFIX = message.substring(1, NEXT_SPACE)
        message = message.substring(NEXT_SPACE + 1)
        chat.prefix = twitchParsePrefix(PREFIX)
      }

      // IRC-Trailing To IRC-Params
      const SPLIT = message.split(" :", 2)
      chat.params = SPLIT[0].split(" ")
      if (SPLIT.length == 2) {
        chat.params.push(SPLIT[1])
      }

      // IRC-Params To IRC-Command + IRC-Params
      chat.command = chat.params[0].toUpperCase()
      chat.params.shift()

      chatList.push(chat)
    })
    return chatList
  }

  function twitchParseTags(tags) {
    let parsedTags = {}
    const SPLIT_TAGS = tags.split(";")

    SPLIT_TAGS.forEach((tag) => {
      const SPLIT_TAG = tag.split("=", 2)
      let tagValue = null
      if (SPLIT_TAG[1] != "") {
        tagValue = SPLIT_TAG[1]
      }

      switch (SPLIT_TAG[0]) {
        case "badge-info":
        case "badge":
          if (tagValue == null) {
            parsedTags[SPLIT_TAG[0]] = null
            break
          }

          let badgeDict = {}
          const BADGES = tagValue.split(",")
          BADGES.forEach((pair) => {
            const BADGE_PARTS = pair.split("/", 2)
            badgeDict[BADGE_PARTS[0]] = BADGE_PARTS[1]
          })

          parsedTags[SPLIT_TAG[0]] = badgeDict
          break
        case "emotes":
          if (tagValue == null) {
            parsedTags[SPLIT_TAG[0]] = null
            break
          }

          let emoteDict = {}
          const EMOTES = tagValue.split("/")
          EMOTES.forEach((emote) => {
            const EMOTE_PARTS = emote.split(":")
            let textPositions = []

            const POSITIONS = EMOTE_PARTS[1].split(",")
            POSITIONS.forEach((position) => {
              const POSITION_PARTS = position.split("-", 2)
              textPositions.push({
                start: parseInt(POSITION_PARTS[0]),
                end: parseInt(POSITION_PARTS[1])
              })
            })
            emoteDict[EMOTE_PARTS[0]] = textPositions
          })
          parsedTags[SPLIT_TAG[0]] = emoteDict
          break
        case "emote-sets":
          const EMOTE_SET_IDS = tagValue.split(",")
          parsedTags[SPLIT_TAG[0]] = EMOTE_SET_IDS
          break
        default:
          parsedTags[SPLIT_TAG[0]] = tagValue
      }
    })

    return parsedTags
  }

  function twitchParsePrefix(prefix) {
    let parsedPrefix = {}
    const SPLIT_PREFIX = prefix.split(/!|@/)

    switch (SPLIT_PREFIX.length) {
      case 1:
        parsedPrefix["host"] = SPLIT_PREFIX[0]
        break
      case 2:
        parsedPrefix["nick"] = SPLIT_PREFIX[0]
        parsedPrefix["host"] = SPLIT_PREFIX[1]
      case 3:
        parsedPrefix["nick"] = SPLIT_PREFIX[0]
        parsedPrefix["user"] = SPLIT_PREFIX[1]
        parsedPrefix["host"] = SPLIT_PREFIX[2]
      default:
        parsedPrefix["raw"] = prefix
    }
    return parsedPrefix
  }
</script>

<script id="youtube-script">
  function youtubeParseChat(actions, channelID) {
    let chatList = []
    actions.forEach(action => {
      const RENDERER = actionToRenderer(action)
      if (!RENDERER) {
        return
      }

      let messageList = []
      if ("message" in RENDERER) {
        const MESSAGE_RUNS = RENDERER.message.runs
        for (let index = 0; index < MESSAGE_RUNS.length; index++) {
          const RUN = MESSAGE_RUNS[index]
          if (RUN.text) {
            messageList.push({
              text: RUN.text
            })
            continue
          }
          if (RUN.emoji) {
            const IS_CUSTOM_EMOJI = RUN.emoji.isCustomEmoji
            messageList.push({
              text: IS_CUSTOM_EMOJI ? RUN.emoji.shortcuts[0] : RUN.emoji.emojiId,
              isCustomEmoji: IS_CUSTOM_EMOJI,
              image: RUN.emoji.image.thumbnails
            })
          }
        }
      }

      let authorName = ""
      if (RENDERER.authorName) {
        authorName = RENDERER.authorName.simpleText
      }

      const CHAT = {
        author: {
          name: authorName,
          id: RENDERER.authorExternalChannelId,
          image: RENDERER.authorPhoto.thumbnails,
          membership: null
        },
        message: messageList,
        superchat: null,

        isMembership: false,
        isOwner: false,
        isModerator: false,
        isVerified: false,
        timestampMilliSecond: Math.floor(RENDERER.timestampUsec / 1000),
      }

      // Badge
      if (RENDERER.authorBadges) {
        RENDERER.authorBadges.forEach(badgeData => {
          const BADGE = badgeData.liveChatAuthorBadgeRenderer
          switch (true) {
            case BADGE.tooltip.includes("Owner") || BADGE.tooltip.includes("所有者"):
              CHAT.isOwner = true
              break
            case BADGE.tooltip.includes("Moderator") || BADGE.tooltip.includes("モデレーター"):
              CHAT.isModerator = true
              break
            case BADGE.tooltip.includes("Verified") || BADGE.tooltip.includes("確認済み"):
              CHAT.isVerified = true
              break
            case BADGE.tooltip.includes("Member"):
              CHAT.author.membership = {
                label: BADGE.tooltip,
                icon: BADGE.customThumbnail.thumbnails
              }
              CHAT.isMembership = true
              break
          }
        })
      }
      // Super Chat
      if (RENDERER.sticker) {
        console.log(RENDERER)
        let textColor = "#000000"
        if (RENDERER.bodyTextColor) {
          textColor = numToHexColor(RENDERER.bodyTextColor)
        }
        let backgroundColor = "#FFFFFF"
        if (RENDERER.backgroundColor) {
          backgroundColor = numToHexColor(RENDERER.backgroundColor)
        }
        if (RENDERER.bodyBackgroundColor) {
          backgroundColor = numToHexColor(RENDERER.bodyBackgroundColor)
        }

        CHAT.superchat = {
          amount: RENDERER.purchaseAmountText.simpleText,
          textColor: textColor,
          backgroundColor: backgroundColor,
          sticker: {
            image: RENDERER.sticker.thumbnails,
            label: RENDERER.sticker.accessibility.accessibilityData.label
          }
        }
      } else if (RENDERER.purchaseAmountText) {
        console.log(RENDERER)
        let textColor = "#000000"
        if (RENDERER.bodyTextColor) {
          textColor = numToHexColor(RENDERER.bodyTextColor)
        }
        let backgroundColor = "#FFFFFF"
        if (RENDERER.backgroundColor) {
          backgroundColor = numToHexColor(RENDERER.backgroundColor)
        }
        if (RENDERER.bodyBackgroundColor) {
          backgroundColor = numToHexColor(RENDERER.bodyBackgroundColor)
        }

        CHAT.superchat = {
          amount: RENDERER.purchaseAmountText.simpleText,
          textColor: textColor,
          backgroundColor: backgroundColor,
        }
      }

      chatList.push(CHAT)
    })
    return chatList
  }

  function actionToRenderer(action) {
    if (!action.addChatItemAction) {
      return null
    }
    const ITEM = action.addChatItemAction.item

    if (ITEM.liveChatTextMessageRenderer) {
      return ITEM.liveChatTextMessageRenderer
    }
    if (ITEM.liveChatPaidMessageRenderer) {
      return ITEM.liveChatPaidMessageRenderer
    }
    if (ITEM.liveChatPaidStickerRenderer) {
      return ITEM.liveChatPaidStickerRenderer
    }
    if (ITEM.liveChatMembershipItemRenderer) {
      return ITEM.liveChatMembershipItemRenderer
    }
    return null
  }

  function numToHexColor(num = 0) {
    return `#${num.toString(16).slice(2).toLocaleUpperCase()}`
  }
</script>

</html>